<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>South Fade - Owner Dashboard</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --primary: #fcd535;
  --bg: #0a0a0a;
  --card: #1a1a1a;
  --text: #fff;
  --secondary: #b8b8b8;
}
body {
  font-family: "Inter", sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
}
header {
  background: var(--card);
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
header img { height: 50px; }
main {
  max-width: 1100px;
  margin: 2rem auto;
  padding: 1rem;
}
h1 { color: var(--primary); }
.table-container {
  background: var(--card);
  border-radius: 12px;
  overflow: hidden;
  margin-top: 2rem;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
th { color: var(--secondary); text-transform: uppercase; font-size: 0.85rem; }
.status {
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.8rem;
}
.status.Pending { background: rgba(245,158,11,.2); color: #f59e0b; }
.status.Confirmed { background: rgba(16,185,129,.2); color: #10b981; }
.status.Cancelled { background: rgba(239,68,68,.2); color: #ef4444; }
.chart-card {
  background: var(--card);
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 2rem;
}
canvas { max-height: 300px; }
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: rgba(255,255,255,0.1);
  color: white;
  border-radius: 8px;
  padding: 1rem 1.5rem;
  opacity: 0;
  transition: 0.3s;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>
<header>
  <img src="./South-fade.png" alt="South Fade">
  <h2>Owner Dashboard</h2>
</header>

<main>
  <h1>Recent Bookings</h1>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Service</th>
          <th>Subservice</th>
          <th>Date</th>
          <th>Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="bookingsBody">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="chart-card">
    <h2>Most Booked Services</h2>
    <canvas id="serviceChart"></canvas>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwSXsrCsu9crkpHfBqcOAWAQNVtsJlKs3r0QZPDSrwwKfu7AsN2Pjjeee8NS68SyvdG/exec";

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 3000);
}

async function fetchBookings() {
  try {
    const res = await fetch(WEB_APP_URL + "?action=getBookings");
    const json = await res.json();
    if (json.status !== "success") throw new Error(json.message);
    return json.data;
  } catch (err) {
    console.error(err);
    showToast("Error loading bookings");
    return [];
  }
}

function renderBookings(data) {
  const tbody = document.getElementById("bookingsBody");
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="6">No bookings found</td></tr>`;
    return;
  }
  tbody.innerHTML = data.slice(0, 10).map(b => `
    <tr>
      <td>${b.Name || ""}</td>
      <td>${b.Service || ""}</td>
      <td>${b.Subservice || ""}</td>
      <td>${b.Date || ""}</td>
      <td>${b.Time || ""}</td>
      <td><span class="status ${b.Status || "Pending"}">${b.Status || "Pending"}</span></td>
    </tr>
  `).join("");
}

function renderChart(data) {
  const ctx = document.getElementById("serviceChart");
  const serviceCount = {};
  data.forEach(b => {
    const s = b.Service || "Unknown";
    serviceCount[s] = (serviceCount[s] || 0) + 1;
  });
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(serviceCount),
      datasets: [{
        data: Object.values(serviceCount),
        backgroundColor: ["#fcd535", "#10b981", "#3b82f6", "#ef4444", "#a855f7", "#f59e0b"],
      }]
    },
    options: {
      plugins: { legend: { labels: { color: "#fff" } } },
    }
  });
}

async function initDashboard() {
  const data = await fetchBookings();
  renderBookings(data);
  renderChart(data);
}

document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
