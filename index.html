<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>South Fade Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
/* ====== KEEP EXACT UI / BRAND COLORS AS REQUESTED ====== */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:"Helvetica Neue",Arial,sans-serif;background:#0a0a0a;color:#f0f0f0;min-height:100vh;}
header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;
background:linear-gradient(135deg,#000,#1a1a1a);color:#FFD700;padding:18px 22px;
border-bottom:1px solid #222;box-shadow:0 4px 15px rgba(0,0,0,0.5);position:sticky;top:0;z-index:50;}
.brand{display:flex;gap:10px;align-items:center;}
.brand h1{font-size:1.2rem;font-weight:800;}
.btn{padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:all .2s;}
.btn-primary{background:#FFD700;color:#000;}
.btn-primary:hover{background:#e6c200;transform:translateY(-2px);}
.btn-secondary{background:#333;color:#FFD700;border:1px solid #FFD700;margin-left:8px;}
.btn-secondary:hover{background:#444;}
.container{max-width:1400px;margin:26px auto;padding:0 20px 80px;}

.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:22px;}
.stat{background:#121212;padding:18px;border-radius:10px;border-left:4px solid #FFD700;
box-shadow:0 4px 12px rgba(0,0,0,0.35);}
.stat h3{color:#bbb;font-size:0.8rem;text-transform:uppercase;margin-bottom:8px;}
.stat .num{font-size:2.1rem;color:#FFD700;font-weight:800;}
.stat .lbl{color:#888;font-size:0.9rem;}

.table-box{background:#121212;border-radius:10px;overflow:hidden;border:1px solid #222;
box-shadow:0 4px 12px rgba(0,0,0,0.35);}
.table-header{display:flex;justify-content:space-between;align-items:center;gap:10px;
padding:16px 18px;background:#161616;border-bottom:1px solid #222;flex-wrap:wrap;}
.table-header h2{color:#FFD700;font-size:1rem;font-weight:700;}
.search{position:relative;width:100%;max-width:320px;}
.search input{width:100%;padding:10px 40px 10px 14px;border-radius:25px;border:1px solid #333;background:#1a1a1a;color:#fff;}
.search i{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#777;}

.table-scroll{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:900px;}
th, td{padding:12px 14px;border-bottom:1px solid #222;text-align:left;}
th{background:#1a1a1a;color:#FFD700;font-size:0.78rem;text-transform:uppercase;}
td{color:#ddd;font-size:0.95rem;}
.badge{display:inline-block;padding:5px 10px;border-radius:18px;font-weight:700;text-transform:uppercase;font-size:0.78rem;}
.badge-confirmed{background:rgba(40,167,69,0.12);color:#56d678;border:1px solid #2b7a44;}
.badge-cancelled{background:rgba(220,53,69,0.12);color:#ff6b7f;border:1px solid #8a2a33;}
.badge-finished{background:rgba(0,0,0,0.2);color:#aaa;border:1px solid #444;}

.loading, .no-data{text-align:center;padding:36px;color:#888;}
.spinner{border:3px solid rgba(255,215,0,0.18);border-top:3px solid #FFD700;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:10px auto 12px;}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* Add Booking Modal - slide up full-screen */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;align-items:flex-end;justify-content:center;opacity:0;visibility:hidden;transition:opacity .25s ease,visibility .25s ease;z-index:999;}
.modal.active{opacity:1;visibility:visible;}
.modal-content{background:#111;width:100%;max-width:900px;border-radius:18px 18px 0 0;padding:18px;border-top:2px solid #FFD700;transform:translateY(100%);transition:transform .35s cubic-bezier(.22,1,.36,1);max-height:95vh;display:flex;flex-direction:column;}
.modal.active .modal-content{transform:translateY(0);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.modal-header h3{color:#FFD700;margin:0;font-size:1.1rem;}
.modal-close{background:none;border:none;color:#888;font-size:1.6rem;cursor:pointer;}
.modal-body{overflow:auto;padding-right:6px;}
.modal-footer{padding-top:12px;margin-top:8px;border-top:1px solid #222;}

/* booking form styles reused */
label{display:block;margin-bottom:6px;color:#ffd700;font-weight:600}
input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff;font-size:1rem;margin-bottom:14px}
.time-slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:8px}
.slot{padding:10px;border-radius:8px;background:#222;border:1px solid #444;text-align:center;cursor:pointer;user-select:none}
.slot:hover:not(.disabled){background:#2a2a2a;border-color:#ffd700;transform:translateY(-2px)}
.slot.selected{background:#ffd700;color:#000;border-color:#ffd700;font-weight:700}
.slot.disabled{background:#1a1a1a;color:#666;opacity:.6;cursor:not-allowed;text-decoration:line-through}
.btn.full{width:100%;padding:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#ffd700,#d4af37);color:#000;font-weight:800;cursor:pointer}
.gold-note{color:#FFD700;font-size:0.9rem;margin-top:10px;text-align:center}
.muted{color:#999;font-size:.9rem;text-align:center}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:840px){.form-grid{grid-template-columns:1fr}.modal-content{border-radius:16px 16px 0 0;}}

/* Bottom pager controls */
.pager{display:flex;gap:8px;align-items:center;justify-content:center;padding:16px 0;color:#ddd}
.pager button{background:#222;color:#FFD700;border:1px solid #333;padding:8px 12px;border-radius:8px;cursor:pointer}
.pager .page-num{padding:6px 10px;border-radius:6px;background:#161616;border:1px solid #333;color:#fff;min-width:120px;text-align:center}

/* responsive adjustments */
@media(max-width:1100px){ table{min-width:700px;} }
@media(max-width:700px){
  th,td{padding:10px 8px;font-size:0.85rem;}
  .brand h1{font-size:1rem;}
  header{padding:12px;}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1><i class="fas fa-cut"></i> South Fade Admin</h1>
    <p style="color:#ddd;margin-left:6px;">Dashboard</p>
  </div>
  <div>
    <button id="addBookingBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Booking</button>
    <button id="clearBtn" class="btn btn-secondary"><i class="fas fa-trash"></i> Clear</button>
    <button id="refreshBtn" class="btn btn-primary"><i class="fas fa-sync"></i> Refresh</button>
  </div>
</header>

<main class="container">
  <section class="stats">
    <div class="stat"><h3>Today's Bookings</h3><div class="num" id="todayCount">0</div><div class="lbl">Appointments</div></div>
    <div class="stat"><h3>Total Revenue</h3><div class="num" id="revenue">£0.00</div><div class="lbl">Confirmed only</div></div>
    <div class="stat"><h3>Total Bookings</h3><div class="num" id="totalCount">0</div><div class="lbl">Selected date</div></div>
  </section>

  <section class="table-box">
    <div class="table-header">
      <div>
        <h2><i class="fas fa-calendar-alt"></i> Bookings</h2>
        <div id="viewingLabel" style="color:#ddd;margin-top:6px">Viewing: <span id="viewingDate"></span></div>
      </div>
      <div class="search"><input id="searchBox" type="text" placeholder="Search name, email, or barber..." /><i class="fas fa-search"></i></div>
    </div>

    <div id="loading" class="loading"><div class="spinner"></div><p>Loading bookings…</p></div>

    <div id="tableContainer" style="display:none">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Email</th><th>Phone</th><th>Date</th><th>Time</th><th>Barber</th><th>Service</th><th>Price</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="noData" class="no-data" style="display:none">
      <div style="font-size:3rem;margin-bottom:8px;">⌧</div>
      <p>No bookings for this date</p>
    </div>

    <div class="pager" id="pagerControls">
      <button id="prevDay">← Today</button>
      <div class="page-num" id="dayIndexLabel">Today</div>
      <button id="nextDay">Tomorrow →</button>
    </div>
  </section>
</main>

<!-- Slide-up booking modal (exact booking form contents) -->
<div id="bookingModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content" role="document">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Add Booking</h3>
      <button class="modal-close" id="closeModalBtn">&times;</button>
    </div>

    <div class="modal-body">
      <form id="modalBookingForm" autocomplete="off">
        <label for="m_name">Full name *</label>
        <input id="m_name" name="name" type="text" required placeholder="Alex Johnson">

        <div class="form-grid">
          <div>
            <label for="m_email">Email *</label>
            <input id="m_email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div>
            <label for="m_phone">Phone *</label>
            <input id="m_phone" name="phone" type="tel" required placeholder="+44 7...">
          </div>
        </div>

        <label for="m_service">Service *</label>
        <select id="m_service" required></select>

        <div class="form-grid">
          <div>
            <label for="m_date">Preferred date *</label>
            <input id="m_date" type="date" required>
          </div>
          <div>
            <label for="m_barber">Choose Master Barber *</label>
            <select id="m_barber" required>
              <option value="">-- choose master barber --</option>
            </select>
          </div>
        </div>

        <label>Available time slots *</label>
        <div id="m_slots" class="time-slots"><div class="muted">Select service, date and master barber to load slots</div></div>
        <input id="m_time" name="time" type="hidden" required>

        <label for="m_notes">Notes (optional)</label>
        <textarea id="m_notes" rows="3" placeholder="Anything we should know?"></textarea>

      </form>
    </div>

    <div class="modal-footer">
      <button id="m_submitBtn" class="btn full" type="submit" form="modalBookingForm"><i class="fas fa-calendar-check"></i> Book appointment</button>
    </div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
/* ================= CONFIG - KEEP KEYS/URLS YOU PROVIDED ================= */
const SUPABASE_URL = 'https://ufcfbggsjemgzcmdhpts.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmY2ZiZ2dzamVtZ3pjbWRocHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjMzNjYsImV4cCI6MjA3NTkzOTM2Nn0.IWB96tPDcVcCp36azPNLewik41xL3FrDjLLtIMqwT-4';
const EMAIL_WEBHOOK = 'https://script.google.com/macros/s/AKfycbzhZNRIOPimun3NF-9ZTiSF7QHNISm1dczpIEHx6rg2eyElL7FKBLd1mxOHQ34exVM/exec';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= BARBERS + SERVICES (front-end driven) ================= */
const BARBERS = ['Alex','Moh','Yass','Ali'];
const BARBER_SCHEDULE = {
  'Alex':[0,1,2,3,4,5,6],
  'Moh':[1,2],
  'Yass':[3,4,5,6],
  'Ali':[5,6,0]
};

const servicesData = [
  { id:1, title:'Classic/Fade', prices:[
      { name:'Buzz cut Fade', price:'24' },
      { name:'Wash & cut', price:'25' },
      { name:'Skin Fade', price:'27' },
      { name:'Student', price:'23' },
      { name:'Student Skin fade', price:'25' }
    ]},
  { id:2, title:'Scissor Cut', prices:[
      { name:'Scissor Cut', price:'27' },
      { name:'Restyle', price:'30' },
      { name:'Complimentary wash with every haircut', price:'0' }
    ]},
  { id:3, title:'Beard Trim', prices:[
      { name:'Beard Trim clipper', price:'17' },
      { name:'Beard trim Shape up & hot Towel', price:'20' },
      { name:'Hot Towel Shave', price:'25' },
      { name:'Complimentary wash with every haircut', price:'0' }
    ]},
  { id:4, title:'Special Treatment', prices:[
      { name:'Nose & Ear waxing', price:'10' },
      { name:'Threading', price:'10' },
      { name:'Facial', price:'20' },
      { name:'Face mask', price:'10' }
    ]},
  { id:5, title:'Kids Cut', prices:[
      { name:'Boys Cut', price:'20' },
      { name:'Girls Cut', price:'25' },
      { name:'Complimentary wash with every haircut', price:'0' }
    ]},
  { id:6, title:'O.A.P Haircut', prices:[
      { name:'O.A.P Haircut', price:'22' },
      { name:'Complimentary wash with every haircut', price:'0' }
    ]},
  { id:7, title:'Packages', prices:[
      { name:'South Fade Signature (Wash + Cut + Beard + Hot Towel + Facial)', price:'55' },
      { name:'Skin fade + beard + shape up and hot towel', price:'45' },
      { name:'Hair cut + beard + shape up + hot towel', price:'42' },
      { name:'Hair cut + beard trim clipper only', price:'39' }
    ]}
];

/* ================= DOM refs ================= */
const tableBody = document.getElementById('tableBody');
const loading = document.getElementById('loading');
const noData = document.getElementById('noData');
const tableContainer = document.getElementById('tableContainer');
const todayCountEl = document.getElementById('todayCount');
const revenueEl = document.getElementById('revenue');
const totalCountEl = document.getElementById('totalCount');
const searchBox = document.getElementById('searchBox');
const refreshBtn = document.getElementById('refreshBtn');
const clearBtn = document.getElementById('clearBtn');
const addBookingBtn = document.getElementById('addBookingBtn');
const bookingModal = document.getElementById('bookingModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const modalForm = document.getElementById('modalBookingForm');
const m_name = document.getElementById('m_name');
const m_email = document.getElementById('m_email');
const m_phone = document.getElementById('m_phone');
const m_service = document.getElementById('m_service');
const m_date = document.getElementById('m_date');
const m_barber = document.getElementById('m_barber');
const m_slots = document.getElementById('m_slots');
const m_time = document.getElementById('m_time');
const m_notes = document.getElementById('m_notes');
const m_submitBtn = document.getElementById('m_submitBtn');
const viewingDateEl = document.getElementById('viewingDate');
const prevDayBtn = document.getElementById('prevDay');
const nextDayBtn = document.getElementById('nextDay');
const dayIndexLabel = document.getElementById('dayIndexLabel');

/* ================= STATE ================= */
// dayOffset: 0 = today, 1 = tomorrow
let dayOffset = 0;
function getSelectedDate(){
  const d = new Date();
  d.setDate(d.getDate() + dayOffset);
  return d;
}

// clearedForDate: map dateStr => Set(ids) for rows hidden on dashboard only
let clearedForDate = {};
(function loadCleared(){
  try{
    const v = JSON.parse(localStorage.getItem('sf_dashboard_cleared') || '{}');
    Object.keys(v).forEach(k => clearedForDate[k] = new Set(v[k]));
  }catch(e){ clearedForDate = {}; }
})();
function persistCleared(){
  const out = {};
  Object.keys(clearedForDate).forEach(k => out[k] = Array.from(clearedForDate[k]));
  localStorage.setItem('sf_dashboard_cleared', JSON.stringify(out));
}

/* ========= Utilities ========= */
function formatDateISO(d){ return d.toISOString().split('T')[0]; }
function formatDisplayDate(d){
  const dt = new Date(d);
  return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* 40-minute slot generation */
function generate40MinSlotsForDay(dayIndex){
  const open = 9;
  const close = (dayIndex === 0) ? 18 : (dayIndex === 6) ? 19 : 20;
  const out = [];
  let h = open, m = 0;
  while (h < close || (h === close && m === 0)) {
    const t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    out.push(t);
    m += 40;
    if (m >= 60) { m -= 60; h += 1; }
    if (h > close) break;
  }
  return out.filter(t=>{
    const [hh,mm]=t.split(':').map(Number);
    const minutes = hh*60+mm;
    const closeMinutes = close*60;
    return minutes < closeMinutes;
  });
}

/* ================= Load bookings for selected day (today or tomorrow) ================= */
async function loadBookings(){
  const selectedDate = getSelectedDate();
  const dateStr = formatDateISO(selectedDate);
  viewingDateEl.textContent = `${formatDisplayDate(selectedDate)} (${dateStr})`;
  dayIndexLabel.textContent = dayOffset === 0 ? 'Today' : 'Tomorrow';

  loading.style.display = 'block';
  noData.style.display = 'none';
  tableContainer.style.display = 'none';
  tableBody.innerHTML = '';

  // fetch bookings where booking_date == dateStr
  const { data, error } = await sb
    .from('bookings')
    .select('*')
    .eq('booking_date', dateStr)
    .order('booking_time', { ascending: true });

  loading.style.display = 'none';
  if(error){ console.error('loadBookings error', error); noData.style.display = 'block'; updateStats([], dateStr); return; }
  if(!data || data.length === 0){ noData.style.display = 'block'; updateStats([], dateStr); return; }

  const clearedSet = clearedForDate[dateStr] || new Set();
  const visible = data.filter(b => !clearedSet.has(String(b.id)));

  tableContainer.style.display = visible.length ? 'block' : 'none';
  if(!visible.length) noData.style.display = 'block';

  renderTable(visible);
  updateStats(data, dateStr); // pass full data for accurate counts & revenue
}

/* render visible rows */
function renderTable(rows){
  tableBody.innerHTML = '';
  rows.forEach(b => {
    const tr = document.createElement('tr');

    const statusClass = (b.status === 'confirmed') ? 'badge-confirmed' : (b.status === 'cancelled') ? 'badge-cancelled' : 'badge-finished';
    const cancelBtnHTML = (b.status === 'confirmed')
      ? `<button data-id="${b.id}" class="btn-cancel" style="background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:700;">✖ Cancel</button>`
      : `<button data-id="${b.id}" class="btn-mark" style="background:#555;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:700;">↺ Mark</button>`;

    tr.innerHTML = `
      <td>${escapeHtml(b.customer_name||'')}</td>
      <td>${escapeHtml(b.customer_email||'')}</td>
      <td>${escapeHtml(b.customer_phone||'')}</td>
      <td>${escapeHtml(b.booking_date||'')}</td>
      <td>${escapeHtml(b.booking_time||'')}</td>
      <td>${escapeHtml(b.barber||'')}</td>
      <td>${escapeHtml(b.service||'')}</td>
      <td>£${b.price||''}</td>
      <td><span class="badge ${statusClass}">${b.status}</span></td>
      <td>${cancelBtnHTML} <button data-hide-id="${b.id}" style="margin-left:6px;background:#333;color:#FFD700;border:1px solid #444;padding:6px 8px;border-radius:6px;cursor:pointer">Hide</button></td>
    `;
    tableBody.appendChild(tr);
  });

  // wire cancel/mark buttons
  tableBody.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!confirm('Set this booking to "cancelled"?')) return;
      btn.disabled = true;
      const { error } = await sb.from('bookings').update({ status:'cancelled' }).eq('id', id);
      if(error){ alert('Cancel failed'); console.error(error); btn.disabled=false; return; }
      loadBookings();
    });
  });

  // wire hide buttons (dashboard-only hide)
  tableBody.querySelectorAll('button[data-hide-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-hide-id');
      const dateStr = formatDateISO(getSelectedDate());
      clearedForDate[dateStr] = clearedForDate[dateStr] || new Set();
      clearedForDate[dateStr].add(String(id));
      persistCleared();
      btn.closest('tr').remove();
      if(!tableBody.querySelectorAll('tr').length){ tableContainer.style.display='none'; noData.style.display='block'; }
      updateStatsFromDashboard();
    });
  });
}

/* update stats (based on full data from supabase for selected date) */
function updateStats(fullData, dateStr){
  const dateBookings = fullData.filter(b => b.booking_date === dateStr);
  const confirmed = dateBookings.filter(b => b.status === 'confirmed');
  const totalRevenue = confirmed.reduce((s,b)=> s + (parseFloat(b.price)||0), 0);
  todayCountEl.textContent = dateBookings.length;
  totalCountEl.textContent = dateBookings.length;
  revenueEl.textContent = `£${totalRevenue.toFixed(2)}`;
}

/* update stats based on visible dashboard rows (after hides) */
function updateStatsFromDashboard(){
  const rows = tableBody.querySelectorAll('tr');
  const count = rows.length;
  let revenueSum = 0;
  rows.forEach(r=>{
    const priceCell = r.children[7]?.textContent?.replace('£','') || '0';
    revenueSum += parseFloat(priceCell) || 0;
  });
  todayCountEl.textContent = count;
  totalCountEl.textContent = count;
  revenueEl.textContent = `£${revenueSum.toFixed(2)}`;
}

/* ============ Search / Refresh / Clear ============ */
searchBox.addEventListener('input', ()=>{
  const q = searchBox.value.toLowerCase();
  tableBody.querySelectorAll('tr').forEach(r=>{
    r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
});

refreshBtn.addEventListener('click', async ()=>{
  // Refresh should remove clears for current viewed date (restore hidden rows) and re-fetch
  const dateStr = formatDateISO(getSelectedDate());
  if(clearedForDate[dateStr]) delete clearedForDate[dateStr];
  persistCleared();
  await loadBookings();
});

clearBtn.addEventListener('click', ()=>{
  if(!confirm('Hide all currently visible bookings for this date on the dashboard? You can restore them with Refresh.')) return;
  const dateStr = formatDateISO(getSelectedDate());
  clearedForDate[dateStr] = clearedForDate[dateStr] || new Set();
  tableBody.querySelectorAll('tr').forEach(r=>{
    const hideBtn = r.querySelector('button[data-hide-id]');
    if(hideBtn) clearedForDate[dateStr].add(String(hideBtn.getAttribute('data-hide-id')));
  });
  persistCleared();
  tableBody.innerHTML = '';
  tableContainer.style.display='none';
  noData.style.display='block';
  updateStatsFromDashboard();
});

/* ================= Modal: populate barbers & services and slot logic (same as booking form) ================= */
function populateModalBarbers(){
  m_barber.innerHTML = '<option value="">-- choose master barber --</option>';
  BARBERS.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; m_barber.appendChild(o); });
}
function populateModalServices(){
  m_service.innerHTML = '';
  servicesData.forEach(cat=>{
    const og = document.createElement('optgroup'); og.label = cat.title;
    cat.prices.forEach(s=>{
      const o = document.createElement('option');
      o.value = JSON.stringify({ name: s.name, price: s.price });
      o.textContent = `${s.name} — £${s.price}`;
      og.appendChild(o);
    });
    m_service.appendChild(og);
  });
}
m_date.min = new Date().toISOString().split('T')[0];

function updateModalBarbersForDate(dateStr){
  if(!dateStr) return;
  const day = new Date(dateStr).getDay();
  Array.from(m_barber.options).forEach(opt=>{
    if(!opt.value) return;
    const works = (BARBER_SCHEDULE[opt.value]||[]).includes(day);
    opt.disabled = !works;
    opt.style.opacity = works ? 1 : 0.4;
  });
}

async function renderModalSlots(){
  m_time.value = '';
  m_slots.innerHTML = '';
  const svcVal = m_service.value, dateVal = m_date.value, barberVal = m_barber.value;
  if(!svcVal || !dateVal || !barberVal){
    m_slots.innerHTML = '<div class="muted">Select service, date and master barber to load slots</div>'; return;
  }
  let svc; try{ svc = JSON.parse(svcVal); }catch(e){ svc = null; }
  const day = new Date(dateVal).getDay();
  const works = (BARBER_SCHEDULE[barberVal]||[]).includes(day);
  if(!works){ m_slots.innerHTML = '<div class="muted">This barber does not work on that day.</div>'; return; }

  const all = generate40MinSlotsForDay(day);
  const { data: booked } = await sb.from('bookings').select('booking_time').eq('booking_date', dateVal).eq('barber', barberVal).eq('status','confirmed');
  const taken = booked ? booked.map(x => x.booking_time) : [];

  all.forEach(t=>{
    const el = document.createElement('div');
    el.className = 'slot';
    el.textContent = t;
    if(taken.includes(t)) el.classList.add('disabled');
    else el.addEventListener('click', ()=> {
      m_slots.querySelectorAll('.slot.selected').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      m_time.value = t;
    });
    m_slots.appendChild(el);
  });
}/* ================= Modal submit (same endpoint/table and webhook) ================= */
modalForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const svc = m_service.value ? JSON.parse(m_service.value) : null;
  const payload = {
    customer_name: m_name.value.trim(),
    customer_email: m_email.value.trim(),
    customer_phone: m_phone.value.trim(),
    barber: m_barber.value,
    service: svc?.name,
    price: svc?.price,
    booking_date: m_date.value,
    booking_time: m_time.value,
    notes: m_notes.value || '',
    status: 'confirmed'
  };

  if(!payload.customer_name || !payload.customer_email || !payload.customer_phone || !payload.barber || !payload.service || !payload.booking_date || !payload.booking_time){
    m_submitBtn.textContent = 'Fill all fields'; setTimeout(()=>m_submitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Book appointment', 2000); return;
  }

  m_submitBtn.disabled = true; m_submitBtn.textContent = 'Booking...';

  // double booking check
  const { data: clash } = await sb.from('bookings').select('id').eq('booking_date', payload.booking_date).eq('booking_time', payload.booking_time).eq('barber', payload.barber).eq('status','confirmed').limit(1);
  if(clash && clash.length){
    m_submitBtn.textContent = 'Slot Unavailable';
    setTimeout(()=>{ m_submitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Book appointment'; m_submitBtn.disabled=false; }, 2000);
    return;
  }

  const { error } = await sb.from('bookings').insert([payload]);
  if(error){ console.error('insert error', error); m_submitBtn.textContent = 'Error — try again'; m_submitBtn.disabled=false; return; }

  // trigger Apps Script webhook (no-cors)
  try { fetch(EMAIL_WEBHOOK, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } catch(e){ console.warn('email webhook fetch failed', e); }

  m_submitBtn.textContent = 'Booking Confirmed ✓';
  setTimeout(()=> {
    m_submitBtn.disabled = false;
    m_submitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Book appointment';
    bookingModal.classList.remove('active');
    modalForm.reset();
    m_slots.innerHTML = '<div class="muted">Select service, date and master barber to load slots</div>';
    // reload if inserted booking belongs to current viewed date
    if(formatDateISO(new Date(payload.booking_date)) === formatDateISO(getSelectedDate())) loadBookings();
  }, 700);
});

/* ================= Modal open/close and wiring inputs ================= */
addBookingBtn.addEventListener('click', ()=>{
  bookingModal.classList.add('active');
  populateModalServices();
  populateModalBarbers();
  m_date.min = new Date().toISOString().split('T')[0];
  modalForm.reset();
  m_slots.innerHTML = '<div class="muted">Select service, date and master barber to load slots</div>';
});
closeModalBtn.addEventListener('click', ()=> bookingModal.classList.remove('active'));
window.addEventListener('click', (ev)=>{ if(ev.target === bookingModal) bookingModal.classList.remove('active'); });

m_date.addEventListener('change', ()=>{
  updateModalBarbersForDate(m_date.value);
  renderModalSlots();
});
m_barber.addEventListener('change', renderModalSlots);
m_service.addEventListener('change', renderModalSlots);

/* ================= Paging: today/tomorrow only ================= */
prevDayBtn.addEventListener('click', ()=>{
  // go to today (offset 0)
  dayOffset = 0;
  loadBookings();
});
nextDayBtn.addEventListener('click', ()=>{
  // go to tomorrow (offset 1)
  dayOffset = 1;
  loadBookings();
});

/* ================= Real-time subscription (optional) ================= */
try {
  sb.channel('bookings-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, () => loadBookings())
    .subscribe();
} catch(e){ console.warn('real-time subscription failed', e); }

/* ================= Init ================= */
(function init(){
  // default to today
  dayOffset = 0;
  loadBookings();
})();
</script>
</body>
</html>