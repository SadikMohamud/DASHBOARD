<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - South Fade</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #0a0a0a;
      color: #f0f0f0;
      line-height: 1.6;
    }
    .hdr {
      background: linear-gradient(135deg, #000, #1a1a1a);
      color: #FFD700;
      padding: 20px 40px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      border-bottom: 1px solid #333;
    }
    .hdr h1 {
      font-size: 1.8em;
      margin-bottom: 5px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    .hdr p {
      opacity: 0.85;
      font-size: 0.95em;
      color: #ccc;
    }
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat {
      background: #121212;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border-left: 4px solid #FFD700;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.15);
    }
    .stat h3 {
      color: #aaa;
      font-size: 0.85em;
      text-transform: uppercase;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .stat .num {
      font-size: 2.4em;
      font-weight: 800;
      color: #FFD700;
      margin-bottom: 5px;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.2);
    }
    .stat .lbl {
      color: #888;
      font-size: 0.9em;
    }
    .filters {
      background: #121212;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      margin-bottom: 30px;
      border: 1px solid #222;
    }
    .filters h2 {
      margin-bottom: 20px;
      color: #FFD700;
      font-size: 1.3em;
      font-weight: 700;
    }
    .fr {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .fg {
      display: flex;
      flex-direction: column;
    }
    .fg label {
      margin-bottom: 5px;
      color: #FFD700;
      font-weight: 600;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .fg input,
    .fg select {
      padding: 10px;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 0.95em;
      background: #1a1a1a;
      color: #fff;
      transition: border-color 0.3s;
    }
    .fg input:focus,
    .fg select:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 700;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn-primary {
      background: #FFD700;
      color: #000;
    }
    .btn-primary:hover {
      background: #e6c200;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    }
    .btn-secondary {
      background: #555;
      color: #fff;
    }
    .btn-secondary:hover {
      background: #444;
    }
    .tbl {
      background: #121212;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      border: 1px solid #222;
    }
    .th {
      padding: 20px 25px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #161616;
    }
    .th h2 {
      color: #FFD700;
      font-size: 1.3em;
      font-weight: 700;
    }
    .sb {
      position: relative;
      width: 300px;
    }
    .sb input {
      width: 100%;
      padding: 10px 40px 10px 15px;
      border: 1px solid #333;
      border-radius: 25px;
      font-size: 0.95em;
      background: #1a1a1a;
      color: #fff;
    }
    .sb input:focus {
      outline: none;
      border-color: #FFD700;
    }
    .sb i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #1a1a1a;
    }
    th {
      padding: 15px;
      text-align: left;
      font-weight: 700;
      color: #FFD700;
      font-size: 0.85em;
      text-transform: uppercase;
      border-bottom: 1px solid #222;
      letter-spacing: 0.5px;
    }
    td {
      padding: 15px;
      border-bottom: 1px solid #222;
      color: #ddd;
    }
    tr:hover {
      background: #1a1a1a;
    }
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-confirmed {
      background: rgba(40, 167, 69, 0.2);
      color: #56d678;
      border: 1px solid #2b7a44;
    }
    .badge-cancelled {
      background: rgba(220, 53, 69, 0.2);
      color: #ff6b7f;
      border: 1px solid #8a2a33;
    }
    .badge-pending {
      background: rgba(255, 215, 0, 0.15);
      color: #FFD700;
      border: 1px solid #aa9000;
    }
    .acts {
      display: flex;
      gap: 8px;
    }
    .bts {
      padding: 6px 12px;
      font-size: 0.8em;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .bv {
      background: #3498db;
      color: #fff;
    }
    .bv:hover {
      background: #2980b9;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    .spinner {
      border: 3px solid rgba(255, 215, 0, 0.2);
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }
    .nd {
      text-align: center;
      padding: 40px;
      color: #777;
    }
    .nd i {
      color: #444;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .mc {
      background: #121212;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #333;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
    }
    .mh {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #222;
    }
    .mh h3 {
      color: #FFD700;
      font-size: 1.4em;
      font-weight: 700;
    }
    .close {
      background: transparent;
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      color: #888;
    }
    .close:hover {
      color: #FFD700;
    }
    .di {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #222;
    }
    .di:last-child {
      border-bottom: none;
    }
    .dl {
      font-weight: 700;
      color: #FFD700;
      margin-bottom: 5px;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .dv {
      color: #ddd;
    }
    .dv a {
      color: #3498db;
      text-decoration: none;
    }
    .dv a:hover {
      text-decoration: underline;
    }
    @media (max-width: 768px) {
      .hdr {
        padding: 15px 20px;
      }
      .hdr h1 {
        font-size: 1.4em;
      }
      .stats {
        grid-template-columns: 1fr;
      }
      .fr {
        grid-template-columns: 1fr;
      }
      .th {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      .sb {
        width: 100%;
      }
      table {
        font-size: 0.8em;
      }
      th,
      td {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="hdr">
    <h1><i class="fas fa-cut"></i> South Fade Admin Dashboard</h1>
    <p>Manage bookings and appointments</p>
  </div>
  <div class="container">
    <div class="stats">
      <div class="stat">
        <h3>Today's Bookings</h3>
        <div class="num" id="todayCount">0</div>
        <div class="lbl">Appointments scheduled</div>
      </div>
      <div class="stat">
        <h3>This Week</h3>
        <div class="num" id="weekCount">0</div>
        <div class="lbl">Total bookings</div>
      </div>
      <div class="stat">
        <h3>This Month</h3>
        <div class="num" id="monthCount">0</div>
        <div class="lbl">Total bookings</div>
      </div>
      <div class="stat">
        <h3>Total Revenue</h3>
        <div class="num" id="revenue">£0</div>
        <div class="lbl">This month</div>
      </div>
    </div>

    <div class="filters">
      <h2><i class="fas fa-filter"></i> Filters</h2>
      <div class="fr">
        <div class="fg">
          <label>Start Date</label>
          <input type="date" id="startDate" />
        </div>
        <div class="fg">
          <label>End Date</label>
          <input type="date" id="endDate" />
        </div>
        <div class="fg">
          <label>Status</label>
          <select id="statusFilter">
            <option value="">All Statuses</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 10px">
        <button class="btn btn-primary" onclick="applyFilters()">
          <i class="fas fa-search"></i> Apply Filters
        </button>
        <button class="btn btn-secondary" onclick="resetFilters()">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
    </div>

    <div class="tbl">
      <div class="th">
        <h2><i class="fas fa-calendar-alt"></i> All Bookings</h2>
        <div class="sb">
          <input
            type="text"
            id="searchBox"
            placeholder="Search by name, email, phone..."
            onkeyup="searchBookings()"
          />
          <i class="fas fa-search"></i>
        </div>
      </div>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading bookings...</p>
      </div>
      <div id="tableContainer" style="display: none">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Contact</th>
              <th>Date & Time</th>
              <th>Service</th>
              <th>Price</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div id="noData" class="nd" style="display: none">
        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px"></i>
        <p>No bookings found</p>
      </div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="mc">
      <div class="mh">
        <h3><i class="fas fa-info-circle"></i> Booking Details</h3>
        <button class="close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = '10mWbLLbm4eEJktFEm2Pk3IW09lP0vHiUp5BmpWW44BA';
    const SHEET_NAME = 'Bookings';
    let allBookings = [];
    let filteredBookings = [];

    // Parse Google's Date(2025,11,7) format
    function parseGoogleDate(str) {
      if (!str || typeof str !== 'string') return null;
      const match = str.match(/Date$$(\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+),\s*(\d+))?/);
      if (!match) return null;
      const [, y, m, d, h = 0, min = 0, s = 0] = match.slice(1).map(Number);
      return new Date(y, m, d, h, min, s);
    }

    // Format phone number from number to string
    function formatPhone(phoneValue) {
      if (phoneValue == null) return '';
      let numStr = phoneValue.toString();
      // Handle scientific notation or float
      if (typeof phoneValue === 'number') {
        numStr = Math.round(phoneValue).toString();
      }
      // UK format: +44 7XXX XXXXXX
      if (numStr.length === 10 && numStr.startsWith('7')) {
        return `+44 ${numStr}`;
      }
      return numStr;
    }

    document.addEventListener('DOMContentLoaded', () => {
      setDefaultDates();
      loadBookings();
    });

    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
      document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];
    }

    async function loadBookings() {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      try {
        // ✅ CORRECT URL — NO SPACES
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        const response = await fetch(url);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const text = await response.text();
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\)/);
        if (!jsonMatch) throw new Error('Invalid Google Sheets response');

        const data = JSON.parse(jsonMatch[1]);

        // Parse rows (skip header)
        allBookings = (data.table.rows || []).map(row => {
          const cells = row.c || [];

          // Parse date & time
          const dateCell = cells[4]?.v;
          const timeCell = cells[5]?.v;
          const createdCell = cells[10]?.v;

          const bookingDate = parseGoogleDate(dateCell);
          const bookingTime = parseGoogleDate(timeCell);
          const createdAt = parseGoogleDate(createdCell);

          return {
            id: cells[0]?.v || '',
            name: cells[1]?.v || '',
            email: cells[2]?.v || '',
            phone: formatPhone(cells[3]?.v),
            date: bookingDate ? bookingDate.toISOString().split('T')[0] : dateCell || '',
            time: bookingTime ? bookingTime.toTimeString().slice(0, 5) : timeCell || '',
            service: cells[6]?.v || '',
            price: cells[7]?.f || `£${parseFloat(cells[7]?.v || 0).toFixed(2)}`,
            notes: cells[8]?.v || '',
            status: cells[9]?.v || 'Confirmed',
            created: createdAt ? createdAt.toLocaleString('en-GB') : createdCell || ''
          };
        });

        filteredBookings = [...allBookings];
        updateStats();
        displayBookings();
      } catch (error) {
        console.error('Error:', error);
        showNoData('Failed to load bookings. Ensure the Google Sheet is public.');
      }
    }

    function updateStats() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

      const confirmed = allBookings.filter(b => b.status === 'Confirmed');
      const todayBookings = confirmed.filter(b => new Date(b.date).getTime() === today.getTime());
      const weekBookings = confirmed.filter(b => new Date(b.date) >= weekStart);
      const monthBookings = confirmed.filter(b => new Date(b.date) >= monthStart);

      const revenue = monthBookings.reduce((sum, b) => {
        const price = parseFloat(b.price.replace(/[^0-9.-]+/g, ''));
        return sum + (isNaN(price) ? 0 : price);
      }, 0);

      document.getElementById('todayCount').textContent = todayBookings.length;
      document.getElementById('weekCount').textContent = weekBookings.length;
      document.getElementById('monthCount').textContent = monthBookings.length;
      document.getElementById('revenue').textContent = '£' + revenue.toFixed(2);
    }

    function displayBookings() {
      const tbody = document.getElementById('tableBody');
      const tableContainer = document.getElementById('tableContainer');
      const noData = document.getElementById('noData');
      const loading = document.getElementById('loading');

      loading.style.display = 'none';

      if (filteredBookings.length === 0) {
        tableContainer.style.display = 'none';
        noData.style.display = 'block';
        return;
      }

      tableContainer.style.display = 'block';
      noData.style.display = 'none';
      tbody.innerHTML = '';

      const sorted = [...filteredBookings].sort((a, b) => new Date(b.date) - new Date(a.date));

      sorted.forEach(b => {
        let statusClass = 'badge-pending';
        if (b.status === 'Confirmed') statusClass = 'badge-confirmed';
        else if (b.status === 'Cancelled') statusClass = 'badge-cancelled';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${b.id}</strong></td>
          <td>${b.name}</td>
          <td>
            <div>${b.email}</div>
            <div style="font-size:.85em;color:#888">${b.phone}</div>
          </td>
          <td>
            <div>${formatDisplayDate(b.date)}</div>
            <div style="font-size:.85em;color:#888">${b.time}</div>
          </td>
          <td>${b.service}</td>
          <td><strong>${b.price}</strong></td>
          <td><span class="badge ${statusClass}">${b.status}</span></td>
          <td>
            <div class="acts">
              <button class="bts bv" onclick='viewBooking(${JSON.stringify(b).replace(/'/g, "&#39;")})'>
                <i class="fas fa-eye"></i> View
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function searchBookings() {
      const term = document.getElementById('searchBox').value.toLowerCase();
      if (!term) {
        filteredBookings = [...allBookings];
      } else {
        filteredBookings = allBookings.filter(b =>
          b.name.toLowerCase().includes(term) ||
          b.email.toLowerCase().includes(term) ||
          b.phone.toLowerCase().includes(term) ||
          b.id.toLowerCase().includes(term) ||
          b.service.toLowerCase().includes(term)
        );
      }
      displayBookings();
    }

    function applyFilters() {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const status = document.getElementById('statusFilter').value;

      filteredBookings = allBookings.filter(b => {
        const bookingDate = new Date(b.date);
        const inDateRange = bookingDate >= startDate && bookingDate <= endDate;
        const matchesStatus = !status || b.status === status;
        return inDateRange && matchesStatus;
      });

      displayBookings();
    }

    function resetFilters() {
      setDefaultDates();
      document.getElementById('statusFilter').value = '';
      document.getElementById('searchBox').value = '';
      filteredBookings = [...allBookings];
      displayBookings();
    }

    function viewBooking(booking) {
      let statusClass = 'badge-pending';
      if (booking.status === 'Confirmed') statusClass = 'badge-confirmed';
      else if (booking.status === 'Cancelled') statusClass = 'badge-cancelled';

      document.getElementById('modalBody').innerHTML = `
        <div class="di"><div class="dl">Booking ID</div><div class="dv"><strong>${booking.id}</strong></div></div>
        <div class="di"><div class="dl">Customer Name</div><div class="dv">${booking.name}</div></div>
        <div class="di"><div class="dl">Email</div><div class="dv"><a href="mailto:${booking.email}">${booking.email}</a></div></div>
        <div class="di"><div class="dl">Phone</div><div class="dv"><a href="tel:${booking.phone}">${booking.phone}</a></div></div>
        <div class="di"><div class="dl">Service</div><div class="dv">${booking.service}</div></div>
        <div class="di"><div class="dl">Date & Time</div><div class="dv">${formatDisplayDate(booking.date)} at ${booking.time}</div></div>
        <div class="di"><div class="dl">Price</div><div class="dv"><strong>${booking.price}</strong></div></div>
        <div class="di"><div class="dl">Status</div><div class="dv"><span class="badge ${statusClass}">${booking.status}</span></div></div>
        ${booking.notes ? `<div class="di"><div class="dl">Notes</div><div class="dv">${booking.notes}</div></div>` : ''}
      `;
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    function showNoData(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('tableContainer').style.display = 'none';
      const nd = document.getElementById('noData');
      nd.style.display = 'block';
      nd.innerHTML = `<i class="fas fa-exclamation-circle" style="font-size:3em;color:#e74c3c;margin-bottom:15px"></i><p>${message}</p>`;
    }

    window.onclick = (e) => {
      if (e.target === document.getElementById('modal')) closeModal();
    };

    // Auto-refresh every 30 seconds
    setInterval(loadBookings, 30000);
  </script>
</body>
</html>
